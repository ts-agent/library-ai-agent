{% extends 'data_analysis/base.html' %}
{% load humanize %}

{% block title %}{{ performance.name }} - 공연 상세{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<style>
    /* Font System */
    body {
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
        letter-spacing: -0.02em;
        background-color: #F9FAFB;
        color: #191F28;
    }

    /* Card Styles */
    .card {
        border: none;
        border-radius: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease-in-out;
        background: white;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }

    .card-title {
        color: #191F28;
        font-weight: 700;
        font-size: 1.5rem;
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    /* Header Styles */
    .page-header {
        margin-bottom: 3rem;
    }

    .page-title {
        color: #191F28;
        font-weight: 700;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        letter-spacing: -0.03em;
        line-height: 1.3;
    }

    .page-subtitle {
        color: #8B95A1;
        font-size: 1rem;
        font-weight: 500;
    }

    /* Info Styles */
    .info-label {
        font-weight: 600;
        color: #8B95A1;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .info-value {
        color: #191F28;
        margin-bottom: 2rem;
        font-size: 1rem;
        font-weight: 500;
        line-height: 1.5;
    }

    /* Upload Section */
    .upload-section {
        background-color: #F8FAFC;
        border-radius: 16px;
        padding: 2rem;
        border: 1px solid #F2F4F6;
        transition: all 0.2s ease-in-out;
    }

    .upload-section:hover {
        border-color: #E5E7EB;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .upload-section h6 {
        color: #191F28;
        font-weight: 700;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        letter-spacing: -0.02em;
    }

    /* Button Styles */
    .btn {
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
    }

    .btn-primary {
        background-color: #3182F6;
        border-color: #3182F6;
    }

    .btn-primary:hover {
        background-color: #1B64DA;
        border-color: #1B64DA;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(49, 130, 246, 0.2);
    }

    .btn-outline-primary {
        color: #3182F6;
        border-color: #E5E7EB;
        background-color: white;
    }

    .btn-outline-primary:hover {
        background-color: #F1F6FE;
        border-color: #3182F6;
        color: #3182F6;
        transform: translateY(-2px);
    }

    .btn-outline-danger {
        color: #F03E3E;
        border-color: #E5E7EB;
        background-color: white;
    }

    .btn-outline-danger:hover {
        background-color: #FFF5F5;
        border-color: #F03E3E;
        color: #F03E3E;
        transform: translateY(-2px);
    }

    /* Table Styles */
    .table {
        margin-bottom: 0;
    }

    .table th {
        color: #8B95A1;
        font-weight: 600;
        font-size: 0.875rem;
        border-bottom-width: 1px;
        padding: 1.25rem;
        border-bottom-color: #F2F4F6;
    }

    .table td {
        color: #191F28;
        font-size: 0.875rem;
        vertical-align: middle;
        padding: 1.25rem;
        border-bottom-color: #F2F4F6;
    }

    .table-sm td, 
    .table-sm th {
        padding: 1rem;
    }

    /* Form Controls */
    .form-control {
        border-radius: 12px;
        border-color: #E5E7EB;
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
        background-color: white;
    }

    .form-control:focus {
        border-color: #3182F6;
        box-shadow: 0 0 0 4px rgba(49, 130, 246, 0.1);
    }

    .form-control::placeholder {
        color: #8B95A1;
    }

    .input-group .btn {
        padding: 0.75rem 1.25rem;
    }

    /* Empty State */
    .empty-state {
        color: #8B95A1;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 2rem;
        background-color: #F8FAFC;
        border-radius: 16px;
        text-align: center;
        justify-content: center;
    }

    /* Calendar Styles */
    .calendar-section {
        min-height: 600px;
        background: white;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .fc {
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    }

    .fc-col-header-cell-cushion,
    .fc-daygrid-day-number {
        color: #191F28;
        text-decoration: none;
        font-weight: 500;
    }

    .fc-button {
        font-family: inherit;
        font-weight: 600;
        border-radius: 8px !important;
        padding: 0.4rem 0.75rem !important;
        font-size: 0.875rem !important;
        transition: all 0.2s ease-in-out !important;
    }

    .fc-button-primary {
        background-color: #3182F6 !important;
        border-color: #3182F6 !important;
    }

    .fc-button-primary:hover {
        background-color: #1B64DA !important;
        border-color: #1B64DA !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(49, 130, 246, 0.2);
    }

    .fc-button-primary:not(:disabled).fc-button-active,
    .fc-button-primary:not(:disabled):active {
        background-color: #1B64DA !important;
        border-color: #1B64DA !important;
    }

    /* 헤더 타이틀 스타일 */
    .fc .fc-toolbar-title {
        font-size: 1.25rem !important;
        font-weight: 600;
    }

    /* 버튼 간격 조정 */
    .fc-toolbar-chunk {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    /* today 버튼 스타일 */
    .fc-today-button {
        font-size: 0.75rem !important;
        padding: 0.35rem 0.65rem !important;
    }

    /* 이전/다음 버튼 아이콘 크기 */
    .fc-prev-button .fc-icon,
    .fc-next-button .fc-icon {
        font-size: 1rem !important;
    }

    /* Crawling Target */
    .crawling-target {
        border-left: 4px solid #3182F6;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #F8FAFC;
        border-radius: 0 16px 16px 0;
        transition: all 0.2s ease-in-out;
    }

    .crawling-target:hover {
        background-color: #F1F6FE;
        transform: translateX(4px);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .card {
            padding: 1.5rem;
            border-radius: 16px;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .upload-section {
            padding: 1.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
        }

        .table td,
        .table th {
            padding: 1rem;
        }
    }

    /* Toggle Switch Styles */
    .form-check.form-switch {
        padding-left: 0;
        margin-right: 0.5rem;
    }

    .form-switch .form-check-input {
        width: 2.5rem;
        height: 1.25rem;
        margin-left: 0;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 1%29'/%3e%3c/svg%3e");
        background-position: left center;
        border-radius: 2rem;
        transition: background-position .15s ease-in-out, background-color .15s ease-in-out;
        cursor: pointer;
    }

    .form-switch .form-check-input:checked {
        background-color: #12B886;
        border-color: #12B886;
        background-position: right center;
    }

    .form-switch .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(18, 184, 134, 0.25);
    }

    .form-switch .form-check-input:not(:checked) {
        background-color: #E9ECEF;
        border-color: #E9ECEF;
    }

    /* Action Buttons */
    .btn-action {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-left: 0.5rem;
    }

    .btn-action i {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 헤더 -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 page-title">{{ performance.name }}</h1>
            <p class="page-subtitle">{{ performance.get_genre_display }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'data_analysis:performance_dashboard' performance.pk %}" class="btn btn-primary">
                <i class="bi bi-graph-up me-1"></i>대시보드
            </a>
            <a href="{% url 'data_analysis:performance_update' performance.pk %}" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>수정
            </a>
            <a href="{% url 'data_analysis:performance_delete' performance.pk %}" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i>삭제
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 기본 정보 -->
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">기본 정보</h5>
                    <div class="row">
                        <!-- 포스터 이미지 -->
                        {% if performance.poster %}
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="poster-container">
                                <img src="{{ performance.poster.url }}" 
                                     alt="{{ performance.name }} 포스터" 
                                     class="img-fluid rounded shadow-sm"
                                     style="width: 100%; height: auto; object-fit: cover;">
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- 공연 정보 -->
                        <div class="col-md-{% if performance.poster %}8{% else %}12{% endif %}">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="info-group">
                                        <p class="info-label mb-1">공연 기간</p>
                                        <p class="info-value">{{ performance.start_date|date:"Y.m.d" }} ~ {{ performance.end_date|date:"Y.m.d" }}</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">공연 장소</p>
                                        <p class="info-value">{{ performance.venue }}</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">관람 연령</p>
                                        <p class="info-value">{{ performance.age_limit }}</p>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="info-group">
                                        <p class="info-label mb-1">러닝타임</p>
                                        <p class="info-value">{{ performance.running_time }}분</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">총 매출</p>
                                        <p class="info-value">{{ performance.total_sales|intcomma }}원</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">총 관객수</p>
                                        <p class="info-value">{{ performance.total_audience|intcomma }}명</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 데이터 업로드 -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">데이터 업로드</h5>
                    
                    <!-- 판매현황 업로드 -->
                    <div class="upload-section mb-4">
                        <h6>판매현황 데이터</h6>
                        <form action="{% url 'data_analysis:sales_data_upload' performance.pk %}" 
                              method="post" 
                              enctype="multipart/form-data"
                              class="mb-3">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="file" class="form-control" name="file" accept=".xlsx,.xls">
                                <button type="submit" class="btn btn-primary">업로드</button>
                            </div>
                        </form>
                        {% if performance.sales_data.exists %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>업로드 일시</th>
                                        <th>파일명</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in performance.sales_data.all %}
                                    <tr>
                                        <td>{{ data.uploaded_at|date:"Y.m.d H:i" }}</td>
                                        <td>{{ data.file.name|default:"파일 없음" }}</td>
                                        <td>
                                            <form action="{% url 'data_analysis:sales_data_delete' data.pk %}" 
                                                  method="post" 
                                                  style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-state">
                            <i class="bi bi-info-circle"></i>
                            업로드된 판매현황 데이터가 없습니다.
                        </p>
                        {% endif %}
                    </div>

                    <!-- 정산서 업로드 -->
                    <div class="upload-section">
                        <h6 class="mb-3">정산서 데이터</h6>
                        <form action="{% url 'data_analysis:settlement_data_upload' performance.pk %}" 
                              method="post" 
                              enctype="multipart/form-data"
                              class="mb-3">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="file" class="form-control" name="settlement_file" accept=".xlsx,.xls">
                                <button type="submit" class="btn btn-primary">업로드</button>
                            </div>
                        </form>
                        {% if performance.settlement_data.exists %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>업로드 일시</th>
                                        <th>파일명</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in performance.settlement_data.all %}
                                    <tr>
                                        <td>{{ data.uploaded_at|date:"Y.m.d H:i" }}</td>
                                        <td>{{ data.file.name|default:"파일 없음" }}</td>
                                        <td>
                                            <form action="{% url 'data_analysis:settlement_data_delete' data.pk %}" 
                                                  method="post" 
                                                  style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-state">
                            <i class="bi bi-info-circle"></i>
                            업로드된 판매현황 데이터가 없습니다.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 크롤링 설정 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">크롤링 설정</h5>
                        <button type="button" 
                                class="btn btn-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addCrawlingTargetModal">
                            <i class="bi bi-plus-lg me-1"></i>추가
                        </button>
                    </div>

                    {% if performance.crawling_targets.exists %}
                    {% for target in performance.crawling_targets.all %}
                    <div class="crawling-target {% if not target.is_active %}inactive{% endif %}" id="target-{{ target.pk }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">{{ target.platform }}</h6>
                                <a href="{{ target.url }}" target="_blank" class="text-muted small">{{ target.url }}</a>
                            </div>
                            <div class="btn-group align-items-center">
                                <div class="form-check form-switch">
                                    <input type="checkbox" 
                                           class="form-check-input toggle-crawling" 
                                           data-target-id="{{ target.pk }}"
                                           {% if target.is_active %}checked{% endif %}
                                           title="크롤링 {% if target.is_active %}비활성화{% else %}활성화{% endif %}">
                                </div>
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary btn-action"
                                        onclick="editCrawlingTarget('{{ target.pk }}')"
                                        title="수정">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form action="{% url 'data_analysis:delete_crawling_target' target.pk %}" 
                                      method="post" 
                                      onsubmit="return confirm('정말 이 크롤링 대상을 삭제하시겠습니까?')"
                                      style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="btn btn-sm btn-outline-danger btn-action"
                                            title="삭제">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% if target.last_crawled_at %}
                        <p class="text-muted small mb-0">
                            마지막 크롤링: {{ target.last_crawled_at|date:"Y.m.d H:i" }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>등록된 크롤링 대상이 없습니다.
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- 마케팅 캘린더 -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                        마케팅 캘린더
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                            <i class="fas fa-plus me-1"></i> 일정 추가
                        </button>
                    </h5>
                    <div id="calendar" class="calendar-section"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 크롤링 대상 추가 모달 -->
<div class="modal fade" id="addCrawlingTargetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">크롤링 대상 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCrawlingTargetForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="platform" class="form-label">플랫폼</label>
                        <select class="form-select" id="platform" name="platform" required>
                            <option value="">플랫폼 선택</option>
                            <option value="nol_ticket">NOL티켓</option>
                            <option value="instagram">인스타그램</option>
                            <option value="facebook">페이스북</option>
                            <option value="twitter">X</option>
                            <option value="youtube">유튜브</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" name="url" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">활성화</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="addCrawlingTarget()">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 크롤링 대상 수정 모달 -->
<div class="modal fade" id="editCrawlingTargetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">크롤링 대상 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCrawlingTargetForm" method="post" onsubmit="return handleEditFormSubmit(event);">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_platform" class="form-label">플랫폼</label>
                        <select class="form-select" id="edit_platform" name="platform" required>
                            <option value="">플랫폼 선택</option>
                            <option value="nol_ticket">NOL티켓</option>
                            <option value="instagram">인스타그램</option>
                            <option value="facebook">페이스북</option>
                            <option value="twitter">X</option>
                            <option value="youtube">유튜브</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="edit_url" name="url" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">활성화</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 일정 추가 모달 -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">마케팅 일정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'data_analysis:marketing_event_create' performance.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">일정 제목</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일</label>
                            <input type="date" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일</label>
                            <input type="date" name="end_date" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">태그</label>
                        <select name="tag" class="form-select">
                            <option value="프로모션">프로모션</option>
                            <option value="SNS">SNS</option>
                            <option value="언론 홍보">언론 홍보</option>
                            <option value="유튜브">유튜브</option>
                            <option value="라디오">라디오</option>
                            <option value="이벤트">이벤트</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">색상</label>
                        <div class="color-select">
                            <select name="color" class="form-control">
                                <option value="#4F46E5">파란색</option>
                                <option value="#10B981">초록색</option>
                                <option value="#F59E0B">주황색</option>
                                <option value="#EF4444">빨간색</option>
                                <option value="#8B5CF6">보라색</option>
                            </select>
                            <div class="color-preview">
                                <div class="color-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 일정 상세 모달 -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일정 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="eventTitle" class="mb-3"></h6>
                <p id="eventDescription" class="text-muted mb-3"></p>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge me-2" id="eventTag"></span>
                    <small class="text-muted" id="eventDate"></small>
                </div>
            </div>
            <div class="modal-footer">
                <form id="deleteEventForm" method="post" class="me-auto">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger">삭제</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="editEventBtn">수정</button>
            </div>
        </div>
    </div>
</div>

<!-- 일정 수정 모달 -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">마케팅 일정 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editEventForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">일정 제목</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일</label>
                            <input type="date" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일</label>
                            <input type="date" name="end_date" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">태그</label>
                        <select name="tag" class="form-select">
                            <option value="프로모션">프로모션</option>
                            <option value="SNS">SNS</option>
                            <option value="언론 홍보">언론 홍보</option>
                            <option value="유튜브">유튜브</option>
                            <option value="라디오">라디오</option>
                            <option value="이벤트">이벤트</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">색상</label>
                        <div class="color-select">
                            <select name="color" class="form-control">
                                <option value="#4F46E5">파란색</option>
                                <option value="#10B981">초록색</option>
                                <option value="#F59E0B">주황색</option>
                                <option value="#EF4444">빨간색</option>
                                <option value="#8B5CF6">보라색</option>
                            </select>
                            <div class="color-preview">
                                <div class="color-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:1050; align-items:center; justify-content:center; flex-direction:column; display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p id="loading-message" class="mt-3 text-secondary">데이터 업로드 중...</p>
</div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        locale: 'ko',
        events: Object.entries(JSON.parse('{{ events_json|safe }}')).map(([date, events]) => 
            events.map(event => ({
                id: event.id,
                title: event.title,
                start: event.start_date,
                end: event.end_date,
                description: event.description,
                tag: event.tag,
                color: event.color,
                backgroundColor: event.color,
                borderColor: event.color
            }))
        ).flat(),
        eventClick: function(info) {
            const event = info.event;
            const modal = document.getElementById('eventDetailModal');
            const modalInstance = new bootstrap.Modal(modal);
            
            // 모달 내용 업데이트
            modal.querySelector('#eventTitle').textContent = event.title;
            modal.querySelector('#eventDescription').textContent = event.extendedProps.description || '설명 없음';
            modal.querySelector('#eventTag').textContent = event.extendedProps.tag;
            modal.querySelector('#eventTag').style.backgroundColor = event.backgroundColor;
            modal.querySelector('#eventDate').textContent = `${event.start.toLocaleDateString()} ~ ${event.end.toLocaleDateString()}`;
            
            // 삭제 폼 설정
            const deleteForm = modal.querySelector('#deleteEventForm');
            deleteForm.action = `/data_analysis/performances/{{ performance.id }}/marketing-calendar/events/${event.id}/delete/`;
            
            // 수정 버튼 이벤트 핸들러
            const editBtn = modal.querySelector('#editEventBtn');
            editBtn.onclick = function() {
                modalInstance.hide();
                showEditEventModal(event);
            };
            
            modalInstance.show();
        }
    });
    calendar.render();
    
    // 색상 선택 미리보기 (추가 모달)
    const colorSelect = document.querySelector('#addEventModal select[name="color"]');
    const colorDot = document.querySelector('#addEventModal .color-dot');
    
    function updateColorPreview(select, dot) {
        dot.style.backgroundColor = select.value;
    }
    
    colorSelect.addEventListener('change', () => updateColorPreview(colorSelect, colorDot));
    updateColorPreview(colorSelect, colorDot);
    
    // 색상 선택 미리보기 (수정 모달)
    const editColorSelect = document.querySelector('#editEventModal select[name="color"]');
    const editColorDot = document.querySelector('#editEventModal .color-dot');
    
    editColorSelect.addEventListener('change', () => updateColorPreview(editColorSelect, editColorDot));
    
    // 일정 수정 모달 표시 함수
    function showEditEventModal(event) {
        const modal = document.getElementById('editEventModal');
        const form = modal.querySelector('#editEventForm');
        const modalInstance = new bootstrap.Modal(modal);
        
        // 폼 데이터 설정
        form.action = `/data_analysis/performances/{{ performance.id }}/marketing-calendar/events/${event.id}/update/`;
        form.querySelector('input[name="title"]').value = event.title;
        form.querySelector('textarea[name="description"]').value = event.extendedProps.description || '';
        form.querySelector('input[name="start_date"]').value = event.start.toISOString().split('T')[0];
        form.querySelector('input[name="end_date"]').value = event.end.toISOString().split('T')[0];
        form.querySelector('select[name="tag"]').value = event.extendedProps.tag;
        form.querySelector('select[name="color"]').value = event.backgroundColor;
        
        // 색상 미리보기 업데이트
        updateColorPreview(editColorSelect, editColorDot);
        
        modalInstance.show();
    }

    // 크롤링 대상 토글 이벤트 처리
    document.querySelectorAll('.toggle-crawling').forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            const targetId = this.dataset.targetId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/data_analysis/crawling/${targetId}/toggle/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    // 토글 상태를 원래대로 되돌림
                    this.checked = !this.checked;
                } else {
                    // 토글 상태에 따라 UI 업데이트
                    const targetElement = document.getElementById(`target-${targetId}`);
                    if (data.is_active) {
                        targetElement.classList.remove('inactive');
                    } else {
                        targetElement.classList.add('inactive');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('크롤링 대상 상태 변경 중 오류가 발생했습니다.');
                // 토글 상태를 원래대로 되돌림
                this.checked = !this.checked;
            });
        });
    });

    const form = document.querySelector('form[action$="/sales-data/upload/"]');
    const overlay = document.getElementById('loading-overlay');
    const message = document.getElementById('loading-message');

    if (form && overlay) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            overlay.style.display = 'flex';
            message.textContent = '파일 업로드 중...';

            const url = form.getAttribute('action');
            const formData = new FormData(form);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('업로드 실패: ' + response.statusText);
                }
                message.textContent = '데이터 파싱 중...';
                return response.text();
            }).then(() => {
                message.textContent = '완료! 페이지를 새로고침합니다.';
                setTimeout(() => location.reload(), 1000);
            }).catch(error => {
                overlay.style.display = 'none';
                alert('오류 발생: ' + error);
            });
        });
    }

    // 세션 요약 정보에 안전하게 접근하기 위한 헬퍼 함수
    function getSummaryData(sessionId) {
        // session.summary가 없을 경우 기본값을 반환하는 함수
        const sessions = {{ sessions_json|default:'{}' }};
        const session = sessions[sessionId] || {};
        const summary = session.summary || { r_count: 0, s_count: 0, total_count: 0, total_amount: 0 };
        return summary;
    }
});

// 크롤링 대상 수정 함수
function editCrawlingTarget(targetId) {
    fetch(`/data_analysis/crawling/${targetId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_platform').value = data.platform;
            document.getElementById('edit_url').value = data.url;
            document.getElementById('edit_is_active').checked = data.is_active;
            
            var form = document.getElementById('editCrawlingTargetForm');
            form.action = `/data_analysis/crawling/${targetId}/update/`;
            
            var modal = new bootstrap.Modal(document.getElementById('editCrawlingTargetModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('크롤링 대상 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

// 크롤링 대상 추가 함수
function addCrawlingTarget() {
    const form = document.getElementById('addCrawlingTargetForm');
    const platform = form.querySelector('#platform').value;
    const url = form.querySelector('#url').value;
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!platform || !url) {
        alert('플랫폼과 URL을 모두 입력해주세요.');
        return;
    }
    
    fetch('{% url "data_analysis:add_crawling_target" performance.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            platform: platform,
            url: url,
            is_active: form.querySelector('#is_active').checked
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => Promise.reject(data));
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCrawlingTargetModal'));
            modal.hide();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.error || '크롤링 대상 추가 중 오류가 발생했습니다.');
    });
}

// 크롤링 대상 수정 폼 제출 처리
function handleEditFormSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = {
        platform: form.querySelector('#edit_platform').value,
        url: form.querySelector('#edit_url').value,
        is_active: form.querySelector('#edit_is_active').checked
    };
    
    fetch(form.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => Promise.reject(data));
        }
        return response.json();
    })
    .then(data => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editCrawlingTargetModal'));
        modal.hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.error || '크롤링 대상 수정 중 오류가 발생했습니다.');
    });
    
    return false;
}
</script>
{% endblock %} 