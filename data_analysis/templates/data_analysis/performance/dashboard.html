{% extends 'data_analysis/base.html' %}
{% load humanize %}

{% block title %}{{ performance.name }} 대시보드{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .stats-title {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #212529;
    }
    .stats-subtitle {
        font-size: 0.8rem;
        color: #adb5bd;
    }
    .progress {
        height: 8px;
        margin-top: 1rem;
    }
    .progress-bar {
        border-radius: 4px;
    }
    .chart-container {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .period-selector {
        margin-bottom: 2rem;
    }
    .period-selector .btn {
        border-radius: 20px;
        padding: 0.5rem 1.5rem;
    }
    .period-selector .btn.active {
        background-color: #0d6efd;
        color: white;
    }
    .growth-positive {
        color: #198754;
    }
    .growth-negative {
        color: #dc3545;
    }
    .badge {
        padding: 0.5em 1em;
        border-radius: 20px;
        font-weight: normal;
    }
</style>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <h1>{{ performance.name }} 대시보드</h1>
    <div class="period-selector btn-group">
        <button class="btn btn-outline-primary" data-period="daily">일간</button>
        <button class="btn btn-outline-primary" data-period="weekly">주간</button>
        <button class="btn btn-outline-primary active" data-period="monthly">월간</button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 매출 현황 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-title">매출 현황</div>
                <div class="stats-value">{{ total_amount|intcomma }}원</div>
                <div class="stats-subtitle">목표 매출: {{ target_amount|intcomma }}원</div>
                <div class="progress">
                    <div class="progress-bar {% if sales_achievement >= 100 %}bg-success{% elif sales_achievement >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                         role="progressbar" 
                         style="width: {{ sales_achievement }}%">
                    </div>
                </div>
                <div class="stats-subtitle mt-2">달성률: {{ sales_achievement }}%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-title">판매량</div>
                <div class="stats-value">{{ total_sales_count|intcomma }}매</div>
                <div class="stats-subtitle">
                    객단가: {{ average_ticket_price|intcomma }}원
                    {% if sales_count_growth > 0 %}
                        <span class="growth-positive">▲{{ sales_count_growth }}%</span>
                    {% elif sales_count_growth < 0 %}
                        <span class="growth-negative">▼{{ sales_count_growth_abs }}%</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-title">점유율</div>
                <div class="stats-value">{{ total_occupancy_rate }}%</div>
                <div class="stats-subtitle">
                    유료: {{ paid_rate }}% / 무료: {{ free_rate }}%
                </div>
                <div class="progress">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ paid_rate }}%"></div>
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ free_rate }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-title">객단가 추이</div>
                <div class="stats-value">{{ average_ticket_price|intcomma }}원</div>
                <div class="stats-subtitle">
                    전월 대비
                    {% if price_growth > 0 %}
                        <span class="growth-positive">▲{{ price_growth }}%</span>
                    {% elif price_growth < 0 %}
                        <span class="growth-negative">▼{{ price_growth_abs }}%</span>
                    {% endif %}
                </div>
                <div class="stats-subtitle">최고 객단가: {{ max_ticket_price|intcomma }}원</div>
            </div>
        </div>
    </div>

    <!-- 차트 -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h5>매출 추이</h5>
                <canvas id="salesChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5>점유율 추이</h5>
                <canvas id="occupancyChart"></canvas>
            </div>
        </div>
    </div>

    {% if performance.genre != 'exhibition' %}
    <div class="row">
        <div class="col-md-12">
            <div class="chart-container">
                <h5>캐스팅별 매출</h5>
                <canvas id="castingChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 데이터 준비
    const dateLabels = {{ date_labels|safe }};
    const salesData = {{ sales_data|safe }};
    const targetData = {{ target_data|safe }};
    const totalOccupancyData = {{ total_occupancy_data|safe }};
    const paidRateData = {{ paid_rate_data|safe }};
    const freeRateData = {{ free_rate_data|safe }};

    // 매출 차트
    const salesChart = new Chart(document.getElementById('salesChart'), {
        type: 'line',
        data: {
            labels: dateLabels,
            datasets: [{
                label: '실제 매출',
                data: salesData,
                borderColor: '#0d6efd',
                tension: 0.1
            }, {
                label: '목표 매출',
                data: targetData,
                borderColor: '#dc3545',
                borderDash: [5, 5],
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            }
        }
    });

    // 점유율 차트
    const occupancyChart = new Chart(document.getElementById('occupancyChart'), {
        type: 'line',
        data: {
            labels: dateLabels,
            datasets: [{
                label: '전체 점유율',
                data: totalOccupancyData,
                borderColor: '#0d6efd',
                tension: 0.1
            }, {
                label: '유료 점유율',
                data: paidRateData,
                borderColor: '#198754',
                tension: 0.1
            }, {
                label: '무료 점유율',
                data: freeRateData,
                borderColor: '#dc3545',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    {% if performance.genre != 'exhibition' %}
    // 캐스팅별 매출 차트
    const castingLabels = {{ casting_labels|safe }};
    const castingSalesData = {{ casting_sales_data|safe }};

    const castingChart = new Chart(document.getElementById('castingChart'), {
        type: 'bar',
        data: {
            labels: castingLabels,
            datasets: [{
                label: '매출액',
                data: castingSalesData,
                backgroundColor: '#0d6efd'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    // 기간 선택 버튼 이벤트
    document.querySelectorAll('.period-selector .btn').forEach(button => {
        button.addEventListener('click', function() {
            const period = this.dataset.period;
            document.querySelectorAll('.period-selector .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            window.location.href = `?period=${period}`;
        });
    });
});
</script>
{% endblock %} 