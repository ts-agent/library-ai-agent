{% extends 'data_analysis/base.html' %}
{% load humanize %}

{% block title %}{{ performance.name }} - 공연 상세{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<style>
    /* Font System */
    body {
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    }

    /* Card Styles */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease-in-out;
    }

    .card:hover {
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
    }

    .card-title {
        color: #111827;
        font-weight: 600;
        font-size: 1.125rem;
        margin-bottom: 1.5rem;
    }

    /* Header Styles */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        color: #111827;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .page-subtitle {
        color: #6B7280;
        font-size: 0.875rem;
    }

    /* Info Styles */
    .info-label {
        font-weight: 500;
        color: #4B5563;
        font-size: 0.875rem;
        margin-bottom: 0.375rem;
    }

    .info-value {
        color: #1F2937;
        margin-bottom: 1.5rem;
        font-size: 0.9375rem;
    }

    /* Upload Section */
    .upload-section {
        background-color: #F9FAFB;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #E5E7EB;
    }

    .upload-section h6 {
        color: #111827;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    /* Button Styles */
    .btn {
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0b5ed7;
        transform: translateY(-1px);
    }

    .btn-outline-primary {
        color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
    }

    .btn-outline-danger {
        color: #EF4444;
        border-color: #EF4444;
    }

    .btn-outline-danger:hover {
        background-color: #EF4444;
        color: white;
        transform: translateY(-1px);
    }

    /* Table Styles */
    .table {
        margin-bottom: 0;
    }

    .table th {
        color: #4B5563;
        font-weight: 500;
        font-size: 0.875rem;
        border-bottom-width: 1px;
    }

    .table td {
        color: #1F2937;
        font-size: 0.875rem;
        vertical-align: middle;
    }

    .table-sm td, 
    .table-sm th {
        padding: 0.75rem;
    }

    /* Form Controls */
    .form-control {
        border-radius: 8px;
        border-color: #E5E7EB;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
    }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .input-group .btn {
        padding: 0.625rem 1rem;
    }

    /* Empty State */
    .empty-state {
        color: #6B7280;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Calendar Styles */
    .calendar-section {
        min-height: 600px;
    }

    .fc {
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    }

    .fc-col-header-cell-cushion,
    .fc-daygrid-day-number {
        color: #1F2937;
        text-decoration: none;
    }

    .fc-button {
        font-family: inherit;
        font-weight: 500;
    }

    /* Crawling Target */
    .crawling-target {
        border-left: 4px solid #0d6efd;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background-color: #F9FAFB;
        border-radius: 0 8px 8px 0;
        transition: all 0.2s ease-in-out;
    }

    .crawling-target:hover {
        background-color: #F3F4F6;
    }

    .crawling-target.inactive {
        border-left-color: #9CA3AF;
    }

    /* Color Picker */
    .color-select {
        position: relative;
    }

    .color-select .form-control {
        cursor: pointer;
        padding-left: 40px;
        padding-right: 30px;
    }

    .color-preview {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .color-dot {
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .color-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
        margin-top: 0.25rem;
        padding: 0.5rem 0;
        display: none;
    }

    .color-dropdown.show {
        display: block;
    }

    .color-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .color-option:hover {
        background-color: #F3F4F6;
    }

    .color-option.selected {
        background-color: #F3F4F6;
        font-weight: 500;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .card-body {
            padding: 1.25rem;
        }
        
        .upload-section {
            padding: 1.25rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
        }
    }

    /* Info Group Styles */
    .info-group {
        background-color: #F9FAFB;
        padding: 1rem;
        border-radius: 8px;
        transition: all 0.2s ease-in-out;
    }
    
    .info-group:hover {
        background-color: #F3F4F6;
        transform: translateY(-1px);
    }
    
    .info-label {
        font-weight: 500;
        color: #4B5563;
        font-size: 0.875rem;
    }
    
    .info-value {
        color: #111827;
        font-size: 1rem;
        margin-bottom: 0;
    }
    
    /* Poster Container Styles */
    .poster-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease-in-out;
    }
    
    .poster-container:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .info-group {
            margin-bottom: 1rem;
        }
        
        .poster-container {
            max-width: 300px;
            margin: 0 auto 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 헤더 -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 page-title">{{ performance.name }}</h1>
            <p class="page-subtitle">{{ performance.get_genre_display }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'data_analysis:performance_dashboard' performance.pk %}" class="btn btn-primary">
                <i class="bi bi-graph-up me-1"></i>대시보드
            </a>
            <a href="{% url 'data_analysis:performance_update' performance.pk %}" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>수정
            </a>
            <a href="{% url 'data_analysis:performance_delete' performance.pk %}" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i>삭제
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 기본 정보 -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">기본 정보</h5>
                    <div class="row">
                        <!-- 포스터 이미지 -->
                        {% if performance.poster %}
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="poster-container">
                                <img src="{{ performance.poster.url }}" 
                                     alt="{{ performance.name }} 포스터" 
                                     class="img-fluid rounded shadow-sm"
                                     style="width: 100%; height: auto; object-fit: cover;">
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- 공연 정보 -->
                        <div class="col-md-{% if performance.poster %}8{% else %}12{% endif %}">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="info-group">
                                        <p class="info-label mb-1">공연 기간</p>
                                        <p class="info-value">{{ performance.start_date|date:"Y.m.d" }} ~ {{ performance.end_date|date:"Y.m.d" }}</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">공연 장소</p>
                                        <p class="info-value">{{ performance.venue }}</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">관람 연령</p>
                                        <p class="info-value">{{ performance.age_limit }}</p>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="info-group">
                                        <p class="info-label mb-1">러닝타임</p>
                                        <p class="info-value">{{ performance.running_time }}분</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">총 매출</p>
                                        <p class="info-value">{{ performance.total_sales|intcomma }}원</p>
                                    </div>
                                    
                                    <div class="info-group mt-4">
                                        <p class="info-label mb-1">총 관객수</p>
                                        <p class="info-value">{{ performance.total_audience|intcomma }}명</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 데이터 업로드 -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">데이터 업로드</h5>
                    
                    <!-- 판매현황 업로드 -->
                    <div class="upload-section mb-4">
                        <h6>판매현황 데이터</h6>
                        <form action="{% url 'data_analysis:sales_data_upload' performance.pk %}" 
                              method="post" 
                              enctype="multipart/form-data"
                              class="mb-3">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="file" class="form-control" name="file" accept=".xlsx,.xls">
                                <button type="submit" class="btn btn-primary">업로드</button>
                            </div>
                        </form>
                        {% if performance.sales_data.exists %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>업로드 일시</th>
                                        <th>파일명</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in performance.sales_data.all %}
                                    <tr>
                                        <td>{{ data.uploaded_at|date:"Y.m.d H:i" }}</td>
                                        <td>{{ data.file.name|default:"파일 없음" }}</td>
                                        <td>
                                            <form action="{% url 'data_analysis:sales_data_delete' data.pk %}" 
                                                  method="post" 
                                                  style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-state">
                            <i class="bi bi-info-circle"></i>
                            업로드된 판매현황 데이터가 없습니다.
                        </p>
                        {% endif %}
                    </div>

                    <!-- 정산서 업로드 -->
                    <div class="upload-section">
                        <h6 class="mb-3">정산서 데이터</h6>
                        <form action="{% url 'data_analysis:settlement_data_upload' performance.pk %}" 
                              method="post" 
                              enctype="multipart/form-data"
                              class="mb-3">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="file" class="form-control" name="settlement_file" accept=".xlsx,.xls">
                                <button type="submit" class="btn btn-primary">업로드</button>
                            </div>
                        </form>
                        {% if performance.settlement_data.exists %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>업로드 일시</th>
                                        <th>파일명</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in performance.settlement_data.all %}
                                    <tr>
                                        <td>{{ data.uploaded_at|date:"Y.m.d H:i" }}</td>
                                        <td>{{ data.file.name|default:"파일 없음" }}</td>
                                        <td>
                                            <form action="{% url 'data_analysis:settlement_data_delete' data.pk %}" 
                                                  method="post" 
                                                  style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">
                            <i class="bi bi-info-circle me-1"></i>업로드된 정산서 데이터가 없습니다.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 크롤링 설정 -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">크롤링 설정</h5>
                        <button type="button" 
                                class="btn btn-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addCrawlingTargetModal">
                            <i class="bi bi-plus-lg me-1"></i>추가
                        </button>
                    </div>

                    {% if performance.crawling_targets.exists %}
                    {% for target in performance.crawling_targets.all %}
                    <div class="crawling-target {% if not target.is_active %}inactive{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">{{ target.platform }}</h6>
                                <a href="{{ target.url }}" target="_blank" class="text-muted small">{{ target.url }}</a>
                            </div>
                            <div class="btn-group">
                                <form action="{% url 'data_analysis:toggle_crawling_target' target.pk %}" 
                                      method="post" 
                                      style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="btn btn-sm {% if target.is_active %}btn-success{% else %}btn-secondary{% endif %} me-1">
                                        <i class="bi {% if target.is_active %}bi-play-fill{% else %}bi-pause-fill{% endif %}"></i>
                                    </button>
                                </form>
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary me-1"
                                        onclick="editCrawlingTarget({{ target.pk }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form action="{% url 'data_analysis:delete_crawling_target' target.pk %}" 
                                      method="post" 
                                      style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% if target.last_crawled_at %}
                        <p class="text-muted small mb-0">
                            마지막 크롤링: {{ target.last_crawled_at|date:"Y.m.d H:i" }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>등록된 크롤링 대상이 없습니다.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 마케팅 캘린더 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    마케팅 캘린더
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                        <i class="fas fa-plus me-1"></i> 일정 추가
                    </button>
                </h5>
                <div id="calendar" class="calendar-section"></div>
            </div>
        </div>
    </div>
</div>

<!-- 크롤링 대상 추가 모달 -->
<div class="modal fade" id="addCrawlingTargetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">크롤링 대상 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'data_analysis:add_crawling_target' performance.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="platform" class="form-label">플랫폼</label>
                        <select class="form-select" id="platform" name="platform" required>
                            <option value="">플랫폼 선택</option>
                            <option value="NOL티켓">NOL티켓</option>
                            <option value="인스타그램">인스타그램</option>
                            <option value="페이스북">페이스북</option>
                            <option value="X">X</option>
                            <option value="유튜브">유튜브</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" name="url" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">활성화</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 크롤링 대상 수정 모달 -->
<div class="modal fade" id="editCrawlingTargetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">크롤링 대상 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCrawlingTargetForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_platform" class="form-label">플랫폼</label>
                        <select class="form-select" id="edit_platform" name="platform" required>
                            <option value="">플랫폼 선택</option>
                            <option value="NOL티켓">NOL티켓</option>
                            <option value="인스타그램">인스타그램</option>
                            <option value="페이스북">페이스북</option>
                            <option value="X">X</option>
                            <option value="유튜브">유튜브</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="edit_url" name="url" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">활성화</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 일정 추가 모달 -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">마케팅 일정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'data_analysis:marketing_event_create' performance.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">일정 제목</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일</label>
                            <input type="date" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일</label>
                            <input type="date" name="end_date" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">태그</label>
                        <select name="tag" class="form-select">
                            <option value="프로모션">프로모션</option>
                            <option value="SNS">SNS</option>
                            <option value="언론 홍보">언론 홍보</option>
                            <option value="유튜브">유튜브</option>
                            <option value="라디오">라디오</option>
                            <option value="이벤트">이벤트</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">색상</label>
                        <div class="color-select">
                            <select name="color" class="form-control">
                                <option value="#4F46E5">파란색</option>
                                <option value="#10B981">초록색</option>
                                <option value="#F59E0B">주황색</option>
                                <option value="#EF4444">빨간색</option>
                                <option value="#8B5CF6">보라색</option>
                            </select>
                            <div class="color-preview">
                                <div class="color-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 일정 상세 모달 -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일정 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="eventTitle" class="mb-3"></h6>
                <p id="eventDescription" class="text-muted mb-3"></p>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge me-2" id="eventTag"></span>
                    <small class="text-muted" id="eventDate"></small>
                </div>
            </div>
            <div class="modal-footer">
                <form id="deleteEventForm" method="post" class="me-auto">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger">삭제</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="editEventBtn">수정</button>
            </div>
        </div>
    </div>
</div>

<!-- 일정 수정 모달 -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">마케팅 일정 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editEventForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">일정 제목</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일</label>
                            <input type="date" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일</label>
                            <input type="date" name="end_date" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">태그</label>
                        <select name="tag" class="form-select">
                            <option value="프로모션">프로모션</option>
                            <option value="SNS">SNS</option>
                            <option value="언론 홍보">언론 홍보</option>
                            <option value="유튜브">유튜브</option>
                            <option value="라디오">라디오</option>
                            <option value="이벤트">이벤트</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">색상</label>
                        <div class="color-select">
                            <select name="color" class="form-control">
                                <option value="#4F46E5">파란색</option>
                                <option value="#10B981">초록색</option>
                                <option value="#F59E0B">주황색</option>
                                <option value="#EF4444">빨간색</option>
                                <option value="#8B5CF6">보라색</option>
                            </select>
                            <div class="color-preview">
                                <div class="color-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        locale: 'ko',
        events: Object.entries(JSON.parse('{{ events_json|safe }}')).map(([date, events]) => 
            events.map(event => ({
                id: event.id,
                title: event.title,
                start: event.start_date,
                end: event.end_date,
                description: event.description,
                tag: event.tag,
                color: event.color,
                backgroundColor: event.color,
                borderColor: event.color
            }))
        ).flat(),
        eventClick: function(info) {
            const event = info.event;
            const modal = document.getElementById('eventDetailModal');
            const modalInstance = new bootstrap.Modal(modal);
            
            // 모달 내용 업데이트
            modal.querySelector('#eventTitle').textContent = event.title;
            modal.querySelector('#eventDescription').textContent = event.extendedProps.description || '설명 없음';
            modal.querySelector('#eventTag').textContent = event.extendedProps.tag;
            modal.querySelector('#eventTag').style.backgroundColor = event.backgroundColor;
            modal.querySelector('#eventDate').textContent = `${event.start.toLocaleDateString()} ~ ${event.end.toLocaleDateString()}`;
            
            // 삭제 폼 설정
            const deleteForm = modal.querySelector('#deleteEventForm');
            deleteForm.action = `/data_analysis/performances/{{ performance.id }}/marketing-calendar/events/${event.id}/delete/`;
            
            // 수정 버튼 이벤트 핸들러
            const editBtn = modal.querySelector('#editEventBtn');
            editBtn.onclick = function() {
                modalInstance.hide();
                showEditEventModal(event);
            };
            
            modalInstance.show();
        }
    });
    calendar.render();
    
    // 색상 선택 미리보기 (추가 모달)
    const colorSelect = document.querySelector('#addEventModal select[name="color"]');
    const colorDot = document.querySelector('#addEventModal .color-dot');
    
    function updateColorPreview(select, dot) {
        dot.style.backgroundColor = select.value;
    }
    
    colorSelect.addEventListener('change', () => updateColorPreview(colorSelect, colorDot));
    updateColorPreview(colorSelect, colorDot);
    
    // 색상 선택 미리보기 (수정 모달)
    const editColorSelect = document.querySelector('#editEventModal select[name="color"]');
    const editColorDot = document.querySelector('#editEventModal .color-dot');
    
    editColorSelect.addEventListener('change', () => updateColorPreview(editColorSelect, editColorDot));
    
    // 일정 수정 모달 표시 함수
    function showEditEventModal(event) {
        const modal = document.getElementById('editEventModal');
        const form = modal.querySelector('#editEventForm');
        const modalInstance = new bootstrap.Modal(modal);
        
        // 폼 데이터 설정
        form.action = `/data_analysis/performances/{{ performance.id }}/marketing-calendar/events/${event.id}/update/`;
        form.querySelector('input[name="title"]').value = event.title;
        form.querySelector('textarea[name="description"]').value = event.extendedProps.description || '';
        form.querySelector('input[name="start_date"]').value = event.start.toISOString().split('T')[0];
        form.querySelector('input[name="end_date"]').value = event.end.toISOString().split('T')[0];
        form.querySelector('select[name="tag"]').value = event.extendedProps.tag;
        form.querySelector('select[name="color"]').value = event.backgroundColor;
        
        // 색상 미리보기 업데이트
        updateColorPreview(editColorSelect, editColorDot);
        
        modalInstance.show();
    }
});

// 크롤링 대상 수정 함수
function editCrawlingTarget(targetId) {
    fetch(`/data_analysis/crawling-targets/${targetId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_platform').value = data.platform;
            document.getElementById('edit_url').value = data.url;
            document.getElementById('edit_is_active').checked = data.is_active;
            
            var form = document.getElementById('editCrawlingTargetForm');
            form.action = `/data_analysis/crawling-targets/${targetId}/update/`;
            
            var modal = new bootstrap.Modal(document.getElementById('editCrawlingTargetModal'));
            modal.show();
        });
}
</script>
{% endblock %} 