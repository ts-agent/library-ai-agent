{% extends 'data_analysis/base.html' %}
{% load humanize %}

{% block title %}AI Data Agent{% endblock %}

{% block page_title %}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.css" rel="stylesheet">
<style>
    .genre-filter {
        background: #fff;
        border-radius: 15px;
        padding: 0.5rem 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(8px);
    }
    
    .genre-filter .nav {
        position: relative;
    }
    
    .genre-filter .nav::before {
        content: '';
        position: absolute;
        top: 0;
        left: var(--active-left, 0);
        width: var(--active-width, 0);
        height: var(--active-height, 100%);
        background-color: var(--bs-primary);
        border-radius: 10px;
        transition: all 0.3s ease;
        z-index: 0;
    }
    
    .genre-filter .nav-item {
        margin-right: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .genre-filter .nav-item:last-child {
        margin-right: 0;
    }
    
    .genre-filter .nav-link {
        color: var(--bs-gray-600);
        padding: 0.5rem 1.5rem;
        border-radius: 10px;
        transition: all 0.2s ease;
        position: relative;
        z-index: 2;
    }
    
    .genre-filter .nav-link.active {
        background-color: transparent;
        color: white !important;
        font-weight: 500;
    }

    .stat-card {
        background: #fff;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        height: 100%;
    }

    .chart-container {
        background: #fff;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
        height: 300px;
        contain: content;
    }

    .performance-list {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
    }

    .performance-list .list-group-item {
        border: none;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1rem 1.5rem;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        will-change: opacity, transform;
    }

    .performance-list .list-group-item:last-child {
        border-bottom: none;
    }

    .performance-list .list-group-item.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .performance-item {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .performance-item.fade-in {
        opacity: 1;
        transform: translateY(0);
    }

    .chart-container {
        position: relative;
        width: 100%;
    }

    .btn-group .btn {
        border-radius: 20px;
        padding: 0.375rem 1rem;
    }

    .btn-group .btn:not(:last-child) {
        margin-right: 0.25rem;
    }

    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pt-0">
    <!-- 장르 필터 -->
    <nav class="genre-filter mb-4">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-genre="all">전체</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-genre="concert">콘서트</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-genre="musical">뮤지컬</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-genre="play">연극</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-genre="exhibition">전시</a>
            </li>
        </ul>
    </nav>

    <!-- 통계 카드 -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">총 판매액</h6>
                    <h3 class="mb-0">{{ total_sales|default:0|intcomma }}원</h3>
                    <small class="text-muted">
                        <i class="bi bi-graph-up"></i>
                        전월 대비 {{ sales_growth|default:0 }}% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">총 관객수</h6>
                    <h3 class="mb-0">{{ total_audience|default:0|intcomma }}명</h3>
                    <small class="text-muted">
                        <i class="bi bi-people"></i>
                        전월 대비 {{ audience_growth|default:0 }}% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">평균 객석 점유율</h6>
                    <h3 class="mb-0">{{ avg_occupancy|default:0 }}%</h3>
                    <small class="text-muted">
                        <i class="bi bi-bar-chart"></i>
                        전월 대비 {{ occupancy_growth|default:0 }}% 변화
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">진행중인 공연</h6>
                    <h3 class="mb-0">{{ active_performances|default:0 }}개</h3>
                    <small class="text-muted">
                        <i class="bi bi-calendar-event"></i>
                        이번 달 기준
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 영역 -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-4">월별 판매 추이</h5>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-4">장르별 판매 비율</h5>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="genreDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 공연 목록 -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0">진행중인 공연</h5>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary btn-sm active" data-sort="sales">판매액순</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-sort="audience">관객수순</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-sort="occupancy">점유율순</button>
            </div>
        </div>
        <div class="list-group list-group-flush performance-list">
            {% for performance in performances %}
            <div class="list-group-item performance-item" data-genre="{{ performance.genre }}">
                <div class="row align-items-center g-3">
                    <div class="col-md-4">
                        <h6 class="mb-1">{{ performance.name }}</h6>
                        <small class="text-muted d-flex align-items-center">
                            <i class="bi bi-geo-alt me-1"></i>
                            {{ performance.venue }}
                        </small>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted small">판매액</div>
                        <strong>{{ performance.total_sales|intcomma }}원</strong>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted small">관객수</div>
                        <strong>{{ performance.total_audience|intcomma }}명</strong>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted small">객석 점유율</div>
                        <strong>{{ performance.occupancy }}%</strong>
                    </div>
                    <div class="col-md-2 text-end">
                        <a href="{% url 'data_analysis:performance_detail' performance.id %}" 
                           class="btn btn-outline-primary btn-sm">
                            상세보기
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                <p class="text-muted mb-0">진행중인 공연이 없습니다.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 차트 기본 설정
    Chart.defaults.font.family = 'Pretendard';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    // 성능 최적화를 위한 공통 옵션
    const commonOptions = {
        animation: {
            duration: 400
        },
        elements: {
            line: {
                tension: 0.3
            },
            point: {
                radius: 3,
                hoverRadius: 5
            }
        },
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                titleColor: '#000',
                bodyColor: '#666',
                borderColor: '#ddd',
                borderWidth: 1,
                padding: 10,
                usePointStyle: true,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat('ko-KR', {
                                style: 'currency',
                                currency: 'KRW'
                            }).format(context.parsed.y);
                        }
                        return label;
                    }
                }
            }
        }
    };

    // 월별 판매 추이 차트
    const salesTrendChart = new Chart(
        document.getElementById('salesTrendChart'),
        {
            type: 'line',
            data: {
                labels: ['1월', '2월', '3월', '4월', '5월', '6월'],
                datasets: [{
                    label: '판매액',
                    data: [30000000, 45000000, 55000000, 48000000, 62000000, 75000000],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('ko-KR', {
                                    style: 'currency',
                                    currency: 'KRW',
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                }
            }
        }
    );

    // 장르별 판매 비율 차트
    const genreDistributionChart = new Chart(
        document.getElementById('genreDistributionChart'),
        {
            type: 'doughnut',
            data: {
                labels: ['콘서트', '연극', '뮤지컬', '전시'],
                datasets: [{
                    data: [30, 20, 35, 15],
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(245, 158, 11)',
                        'rgb(239, 68, 68)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = Math.round((value / context.dataset.data.reduce((a, b) => a + b)) * 100);
                                return `${label}: ${percentage}%`;
                            }
                        }
                    }
                }
            }
        }
    );

    // 장르 필터링
    const filterPerformances = (genre) => {
        const items = document.querySelectorAll('.performance-item');
        items.forEach(item => {
            if (genre === 'all' || item.dataset.genre === genre) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    };

    // 장르 필터 슬라이딩 효과
    const navList = document.querySelector('.genre-filter .nav');
    const updateActiveIndicator = (activeLink) => {
        const navRect = navList.getBoundingClientRect();
        const linkRect = activeLink.getBoundingClientRect();
        const width = linkRect.width;
        const left = linkRect.left - navRect.left;
        
        navList.style.setProperty('--active-width', `${width}px`);
        navList.style.setProperty('--active-left', `${left}px`);
        navList.style.setProperty('--active-height', `${linkRect.height}px`);
    };

    // 장르 필터 이벤트
    document.querySelectorAll('.genre-filter .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.genre-filter .nav-link').forEach(el => {
                el.classList.remove('active');
            });
            this.classList.add('active');
            updateActiveIndicator(this);
            filterPerformances(this.dataset.genre);
        });
    });

    // 초기 활성 버튼 위치 설정
    const initialActiveLink = document.querySelector('.genre-filter .nav-link.active');
    if (initialActiveLink) {
        updateActiveIndicator(initialActiveLink);
    }

    // 정렬 기능
    const sortPerformances = (criteria) => {
        const list = document.querySelector('.performance-list');
        const items = Array.from(list.querySelectorAll('.performance-item'));
        
        items.sort((a, b) => {
            let valueA, valueB;
            
            if (criteria === 'sales') {
                valueA = parseInt(a.querySelector('[data-sales]').dataset.sales);
                valueB = parseInt(b.querySelector('[data-sales]').dataset.sales);
            } else if (criteria === 'audience') {
                valueA = parseInt(a.querySelector('[data-audience]').dataset.audience);
                valueB = parseInt(b.querySelector('[data-audience]').dataset.audience);
            } else {
                valueA = parseInt(a.querySelector('[data-occupancy]').dataset.occupancy);
                valueB = parseInt(b.querySelector('[data-occupancy]').dataset.occupancy);
            }
            
            return valueB - valueA;
        });

        items.forEach(item => list.appendChild(item));
    };

    // 정렬 버튼 이벤트
    document.querySelectorAll('[data-sort]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            sortPerformances(this.dataset.sort);
        });
    });

    // 스크롤 애니메이션
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1
    });

    document.querySelectorAll('.performance-item').forEach(item => {
        observer.observe(item);
    });
});
</script>
{% endblock %} 